package staking

import (
	"fmt"
	"math/big"

	"github.com/0xPolygon/polygon-edge/chain"
	"github.com/0xPolygon/polygon-edge/helper/common"
	"github.com/0xPolygon/polygon-edge/helper/hex"
	"github.com/0xPolygon/polygon-edge/helper/keccak"
	"github.com/0xPolygon/polygon-edge/types"
	"github.com/0xPolygon/polygon-edge/validators"
)

var (
	MinValidatorCount = uint64(1)
	MaxValidatorCount = common.MaxSafeJSInt
)

// getAddressMapping returns the key for the SC storage mapping (address => something)
//
// More information:
// https://docs.soliditylang.org/en/latest/internals/layout_in_storage.html
func getAddressMapping(address types.Address, slot int64) []byte {
	bigSlot := big.NewInt(slot)

	finalSlice := append(
		common.PadLeftOrTrim(address.Bytes(), 32),
		common.PadLeftOrTrim(bigSlot.Bytes(), 32)...,
	)

	return keccak.Keccak256(nil, finalSlice)
}

// getIndexWithOffset is a helper method for adding an offset to the already found keccak hash
func getIndexWithOffset(keccakHash []byte, offset uint64) []byte {
	bigOffset := big.NewInt(int64(offset))
	bigKeccak := big.NewInt(0).SetBytes(keccakHash)

	bigKeccak.Add(bigKeccak, bigOffset)

	return bigKeccak.Bytes()
}

// getStorageIndexes is a helper function for getting the correct indexes
// of the storage slots which need to be modified during bootstrap.
//
// It is SC dependant, and based on the SC located at:
// https://github.com/0xPolygon/staking-contracts/
func getStorageIndexes(validator validators.Validator, index int) *StorageIndexes {
	storageIndexes := &StorageIndexes{}
	address := validator.Addr()

	// Get the indexes for the mappings
	// The index for the mapping is retrieved with:
	// keccak(address . slot)
	// . stands for concatenation (basically appending the bytes)
	storageIndexes.AddressToIsValidatorIndex = getAddressMapping(
		address,
		addressToIsValidatorSlot,
	)

	storageIndexes.AddressToStakedAmountIndex = getAddressMapping(
		address,
		addressToStakedAmountSlot,
	)

	storageIndexes.AddressToValidatorIndexIndex = getAddressMapping(
		address,
		addressToValidatorIndexSlot,
	)

	storageIndexes.ValidatorBLSPublicKeyIndex = getAddressMapping(
		address,
		addressToBLSPublicKeySlot,
	)

	// Index for array types is calculated as keccak(slot) + index
	// The slot for the dynamic arrays that's put in the keccak needs to be in hex form (padded 64 chars)
	storageIndexes.ValidatorsIndex = getIndexWithOffset(
		keccak.Keccak256(nil, common.PadLeftOrTrim(big.NewInt(validatorsSlot).Bytes(), 32)),
		uint64(index),
	)

	return storageIndexes
}

// setBytesToStorage sets bytes data into storage map from specified base index
func setBytesToStorage(
	storageMap map[types.Hash]types.Hash,
	baseIndexBytes []byte,
	data []byte,
) {
	dataLen := len(data)
	baseIndex := types.BytesToHash(baseIndexBytes)

	if dataLen <= 31 {
		bytes := types.Hash{}

		copy(bytes[:len(data)], data)

		// Set 2*Size at the first byte
		bytes[len(bytes)-1] = byte(dataLen * 2)

		storageMap[baseIndex] = bytes

		return
	}

	// Set size at the base index
	baseSlot := types.Hash{}
	baseSlot[31] = byte(2*dataLen + 1)
	storageMap[baseIndex] = baseSlot

	zeroIndex := keccak.Keccak256(nil, baseIndexBytes)
	numBytesInSlot := 256 / 8

	for i := 0; i < dataLen; i++ {
		offset := i / numBytesInSlot

		slotIndex := types.BytesToHash(getIndexWithOffset(zeroIndex, uint64(offset)))
		byteIndex := i % numBytesInSlot

		slot := storageMap[slotIndex]
		slot[byteIndex] = data[i]

		storageMap[slotIndex] = slot
	}
}

// PredeployParams contains the values used to predeploy the PoS staking contract
type PredeployParams struct {
	MinValidatorCount uint64
	MaxValidatorCount uint64
}

// StorageIndexes is a wrapper for different storage indexes that
// need to be modified
type StorageIndexes struct {
	ValidatorsIndex              []byte // []address
	ValidatorBLSPublicKeyIndex   []byte // mapping(address => byte[])
	AddressToIsValidatorIndex    []byte // mapping(address => bool)
	AddressToStakedAmountIndex   []byte // mapping(address => uint256)
	AddressToValidatorIndexIndex []byte // mapping(address => uint256)
}

// Slot definitions for SC storage
var (
	validatorsSlot              = int64(0) // Slot 0
	addressToIsValidatorSlot    = int64(1) // Slot 1
	addressToStakedAmountSlot   = int64(2) // Slot 2
	addressToValidatorIndexSlot = int64(3) // Slot 3
	stakedAmountSlot            = int64(4) // Slot 4
	minNumValidatorSlot         = int64(5) // Slot 5
	maxNumValidatorSlot         = int64(6) // Slot 6
	addressToBLSPublicKeySlot   = int64(7) // Slot 7
)

const (
	DefaultStakedBalance = "0x0" // 0 ETH
	//nolint: lll
	StakingSCBytecode = "0x6080604052348015600f57600080fd5b506040516110f93803806110f9833981016040819052602c9160b4565b8082111560a7576040805162461bcd60e51b81526020600482015260248101919091527f4d696e2076616c696461746f7273206e756d2063616e206e6f7420626520677260448201527f6561746572207468616e206d6178206e756d206f662076616c696461746f7273606482015260840160405180910390fd5b60059190915560065560d7565b6000806040838503121560c657600080fd5b505080516020909101519092909150565b611013806100e66000396000f3fe6080604052600436106101185760003560e01c80637a6eea37116100a0578063d94c111b11610064578063d94c111b1461035a578063e387a7ed1461037a578063e804fbf614610390578063f90ecacc146103a5578063facd743b146103dd57600080fd5b80637a6eea37146102a05780637dceceb8146102df578063af6da36e1461030c578063c795c07714610322578063ca1e78191461033857600080fd5b8063373d6132116100e7578063373d61321461021f5780633a4b66f1146102345780633c561f041461023c57806351a9ab321461025e578063714ff4251461028b57600080fd5b806302b7519914610154578063065ae171146101945780632367f6b5146101d45780632def66201461020a57600080fd5b3661014f573332146101455760405162461bcd60e51b815260040161013c90610bda565b60405180910390fd5b61014d610416565b005b600080fd5b34801561016057600080fd5b5061018161016f366004610c11565b60036020526000908152604090205481565b6040519081526020015b60405180910390f35b3480156101a057600080fd5b506101c46101af366004610c11565b60016020526000908152604090205460ff1681565b604051901515815260200161018b565b3480156101e057600080fd5b506101816101ef366004610c11565b6001600160a01b031660009081526002602052604090205490565b34801561021657600080fd5b5061014d6104a0565b34801561022b57600080fd5b50600454610181565b61014d610525565b34801561024857600080fd5b5061025161054c565b60405161018b9190610c87565b34801561026a57600080fd5b5061027e610279366004610c11565b61069d565b60405161018b9190610cec565b34801561029757600080fd5b50600554610181565b3480156102ac57600080fd5b506102be6969e10de76676d080000081565b6040516fffffffffffffffffffffffffffffffff909116815260200161018b565b3480156102eb57600080fd5b506101816102fa366004610c11565b60026020526000908152604090205481565b34801561031857600080fd5b5061018160065481565b34801561032e57600080fd5b5061018160055481565b34801561034457600080fd5b5061034d610737565b60405161018b9190610cff565b34801561036657600080fd5b5061014d610375366004610d61565b610799565b34801561038657600080fd5b5061018160045481565b34801561039c57600080fd5b50600654610181565b3480156103b157600080fd5b506103c56103c0366004610e1a565b6107f7565b6040516001600160a01b03909116815260200161018b565b3480156103e957600080fd5b506101c46103f8366004610c11565b6001600160a01b031660009081526001602052604090205460ff1690565b34600460008282546104289190610e49565b9091555050336000908152600260205260408120805434929061044c908490610e49565b9091555061045b905033610821565b156104695761046933610872565b60405134815233907f9e71bc8eea02a63969f509818f2dafb9254532904319f9dbda79b67bd34a5f3d9060200160405180910390a2565b3332146104bf5760405162461bcd60e51b815260040161013c90610bda565b3360009081526002602052604090205461051b5760405162461bcd60e51b815260206004820152601d60248201527f4f6e6c79207374616b65722063616e2063616c6c2066756e6374696f6e000000604482015260640161013c565b610523610942565b565b3332146105445760405162461bcd60e51b815260040161013c90610bda565b610523610416565b600080546060919067ffffffffffffffff81111561056c5761056c610d4b565b60405190808252806020026020018201604052801561059f57816020015b606081526020019060019003908161058a5790505b50905060005b60005481101561069757600760008083815481106105c5576105c5610e5c565b60009182526020808320909101546001600160a01b03168352820192909252604001902080546105f490610e72565b80601f016020809104026020016040519081016040528092919081815260200182805461062090610e72565b801561066d5780601f106106425761010080835404028352916020019161066d565b820191906000526020600020905b81548152906001019060200180831161065057829003601f168201915b505050505082828151811061068457610684610e5c565b60209081029190910101526001016105a5565b50919050565b600760205260009081526040902080546106b690610e72565b80601f01602080910402602001604051908101604052809291908181526020018280546106e290610e72565b801561072f5780601f106107045761010080835404028352916020019161072f565b820191906000526020600020905b81548152906001019060200180831161071257829003601f168201915b505050505081565b6060600080548060200260200160405190810160405280929190818152602001828054801561078f57602002820191906000526020600020905b81546001600160a01b03168152600190910190602001808311610771575b5050505050905090565b3360009081526007602052604090206107b28282610ef5565b50336001600160a01b03167f472da4d064218fa97032725fbcff922201fa643fed0765b5ffe0ceef63d7b3dc826040516107ec9190610cec565b60405180910390a250565b6000818154811061080757600080fd5b6000918252602090912001546001600160a01b0316905081565b6001600160a01b03811660009081526001602052604081205460ff1615801561086c57506001600160a01b0382166000908152600260205260409020546969e10de76676d080000011155b92915050565b600654600054106108d55760405162461bcd60e51b815260206004820152602760248201527f56616c696461746f72207365742068617320726561636865642066756c6c20636044820152666170616369747960c81b606482015260840161013c565b6001600160a01b03166000818152600160208181526040808420805460ff19168417905583546003909252832081905590810182559080527f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5630180546001600160a01b0319169091179055565b336000908152600260205260408120805490829055600480549192839261096a908490610fb4565b90915550503360009081526001602052604090205460ff161561099057610990336109f0565b604051339082156108fc029083906000818181858888f193505050501580156109bd573d6000803e3d6000fd5b5060405181815233907f0f5bb82176feb1b5e747e28471aa92156a04d9f3ab9f45f28e2d704232b93f75906020016107ec565b60055460005411610a6b576040805162461bcd60e51b81526020600482015260248101919091527f56616c696461746f72732063616e2774206265206c657373207468616e20746860448201527f65206d696e696d756d2072657175697265642076616c696461746f72206e756d606482015260840161013c565b600080546001600160a01b0383168252600360205260409091205410610ac85760405162461bcd60e51b8152602060048201526012602482015271696e646578206f7574206f662072616e676560701b604482015260640161013c565b6001600160a01b0381166000908152600360205260408120548154909190610af290600190610fb4565b9050808214610b77576000808281548110610b0f57610b0f610e5c565b600091825260208220015481546001600160a01b03909116925082919085908110610b3c57610b3c610e5c565b600091825260208083209190910180546001600160a01b0319166001600160a01b039485161790559290911681526003909152604090208290555b6001600160a01b0383166000908152600160209081526040808320805460ff1916905560039091528120819055805480610bb357610bb3610fc7565b600082815260209020810160001990810180546001600160a01b0319169055019055505050565b6020808252601a908201527f4f6e6c7920454f412063616e2063616c6c2066756e6374696f6e000000000000604082015260600190565b600060208284031215610c2357600080fd5b81356001600160a01b0381168114610c3a57600080fd5b9392505050565b6000815180845260005b81811015610c6757602081850181015186830182015201610c4b565b506000602082860101526020601f19601f83011685010191505092915050565b6000602082016020835280845180835260408501915060408160051b86010192506020860160005b82811015610ce057603f19878603018452610ccb858351610c41565b94506020938401939190910190600101610caf565b50929695505050505050565b602081526000610c3a6020830184610c41565b602080825282518282018190526000918401906040840190835b81811015610d405783516001600160a01b0316835260209384019390920191600101610d19565b509095945050505050565b634e487b7160e01b600052604160045260246000fd5b600060208284031215610d7357600080fd5b813567ffffffffffffffff811115610d8a57600080fd5b8201601f81018413610d9b57600080fd5b803567ffffffffffffffff811115610db557610db5610d4b565b604051601f8201601f19908116603f0116810167ffffffffffffffff81118282101715610de457610de4610d4b565b604052818152828201602001861015610dfc57600080fd5b81602084016020830137600091810160200191909152949350505050565b600060208284031215610e2c57600080fd5b5035919050565b634e487b7160e01b600052601160045260246000fd5b8082018082111561086c5761086c610e33565b634e487b7160e01b600052603260045260246000fd5b600181811c90821680610e8657607f821691505b60208210810361069757634e487b7160e01b600052602260045260246000fd5b601f821115610ef057806000526020600020601f840160051c81016020851015610ecd5750805b601f840160051c820191505b81811015610eed5760008155600101610ed9565b50505b505050565b815167ffffffffffffffff811115610f0f57610f0f610d4b565b610f2381610f1d8454610e72565b84610ea6565b6020601f821160018114610f575760008315610f3f5750848201515b600019600385901b1c1916600184901b178455610eed565b600084815260208120601f198516915b82811015610f875787850151825560209485019460019092019101610f67565b5084821015610fa55786840151600019600387901b60f8161c191681555b50505050600190811b01905550565b8181038181111561086c5761086c610e33565b634e487b7160e01b600052603160045260246000fdfea2646970667358221220499309dcfdf5e2e5863a675e0533464c8e4e88736dcf8fa01b82d47d2f84611364736f6c634300081a0033"

)

// PredeployStakingSC is a helper method for setting up the staking smart contract account,
// using the passed in validators as pre-staked validators
func PredeployStakingSC(
	vals validators.Validators,
	params PredeployParams,
) (*chain.GenesisAccount, error) {
	// Set the code for the staking smart contract
	// Code retrieved from https://github.com/0xPolygon/staking-contracts
	scHex, _ := hex.DecodeHex(StakingSCBytecode)
	stakingAccount := &chain.GenesisAccount{
		Code: scHex,
	}

	// Parse the default staked balance value into *big.Int
	val := DefaultStakedBalance
	bigDefaultStakedBalance, err := types.ParseUint256orHex(&val)

	if err != nil {
		return nil, fmt.Errorf("unable to generate DefaultStatkedBalance, %w", err)
	}

	// Generate the empty account storage map
	storageMap := make(map[types.Hash]types.Hash)
	bigTrueValue := big.NewInt(1)
	stakedAmount := big.NewInt(0)
	bigMinNumValidators := big.NewInt(int64(params.MinValidatorCount))
	bigMaxNumValidators := big.NewInt(int64(params.MaxValidatorCount))
	valsLen := big.NewInt(0)

	if vals != nil {
		valsLen = big.NewInt(int64(vals.Len()))

		for idx := 0; idx < vals.Len(); idx++ {
			validator := vals.At(uint64(idx))

			// Update the total staked amount
			stakedAmount = stakedAmount.Add(stakedAmount, bigDefaultStakedBalance)

			// Get the storage indexes
			storageIndexes := getStorageIndexes(validator, idx)

			// Set the value for the validators array
			storageMap[types.BytesToHash(storageIndexes.ValidatorsIndex)] =
				types.BytesToHash(
					validator.Addr().Bytes(),
				)

			if blsValidator, ok := validator.(*validators.BLSValidator); ok {
				setBytesToStorage(
					storageMap,
					storageIndexes.ValidatorBLSPublicKeyIndex,
					blsValidator.BLSPublicKey,
				)
			}

			// Set the value for the address -> validator array index mapping
			storageMap[types.BytesToHash(storageIndexes.AddressToIsValidatorIndex)] =
				types.BytesToHash(bigTrueValue.Bytes())

			// Set the value for the address -> staked amount mapping
			storageMap[types.BytesToHash(storageIndexes.AddressToStakedAmountIndex)] =
				types.StringToHash(hex.EncodeBig(bigDefaultStakedBalance))

			// Set the value for the address -> validator index mapping
			storageMap[types.BytesToHash(storageIndexes.AddressToValidatorIndexIndex)] =
				types.StringToHash(hex.EncodeUint64(uint64(idx)))
		}
	}

	// Set the value for the total staked amount
	storageMap[types.BytesToHash(big.NewInt(stakedAmountSlot).Bytes())] =
		types.BytesToHash(stakedAmount.Bytes())

	// Set the value for the size of the validators array
	storageMap[types.BytesToHash(big.NewInt(validatorsSlot).Bytes())] =
		types.BytesToHash(valsLen.Bytes())

	// Set the value for the minimum number of validators
	storageMap[types.BytesToHash(big.NewInt(minNumValidatorSlot).Bytes())] =
		types.BytesToHash(bigMinNumValidators.Bytes())

	// Set the value for the maximum number of validators
	storageMap[types.BytesToHash(big.NewInt(maxNumValidatorSlot).Bytes())] =
		types.BytesToHash(bigMaxNumValidators.Bytes())

	// Save the storage map
	stakingAccount.Storage = storageMap

	// Set the Staking SC balance to numValidators * defaultStakedBalance
	stakingAccount.Balance = stakedAmount

	return stakingAccount, nil
}
